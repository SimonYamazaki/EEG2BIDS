function EEG2BIDS_MMN(varargin)

%add paths to relevant toolboxes
addpath('/home/simonyj/EEG_flanker/fieldtrip/')
addpath('/home/simonyj/EEG_flanker/fieldtrip/fileio/')
addpath('/home/simonyj/EEG_flanker/fieldtrip/utilities/')
addpath('/mrhome/simonyj/biosig-code/biosig4matlab/t200_FileAccess/')
addpath('/home/simonyj/EEG2BIDS/utils/')

%% Setup  

%Specify the data directories
%if more than one session is present data_dir should be a struct with
%fieldnames corresponding to session names
data_dir.via11 = '/home/simonyj/EEG_MMN';
data_dir.via15 = '/home/simonyj/EEG_MMN';
bids_dir = varargin{1}; %bids_dir is parsed as the first input in the function 
%bids_dir = '/home/simonyj/EEG_BIDS_MMN';

%Path to the EEG2BIDS dir from https://github.com/SimonYamazaki/EEG2BIDS
EEG2BIDS_tool_dir = '/home/simonyj/EEG2BIDS';

%The task name
%from BIDS specification: Each task has a unique label that MUST only consist 
%of letters and/or numbers (other characters, including spaces and underscores, are not allowed).
task = 'MMN';

%start event value and the number of expected events with this value
trig_start_value = 65281;
n_trig_start = 1;

%Search pattern for data files. 
%data_file follows the same structure as data_dir with respect to sessions
%field names must be identical to data_dir field names
data_file.via11 = '*_MMN.bdf';
data_file.via15 = '*_MMN.bdf';

%keywords in the data_file name that should not be present. 
%if this keyword is found, the file will not be moved to BIDS
nono_keywords_in_filename = {'Flanker','ASSR'};

%search pattern for other files that must exist along side the data file
%follows the same structure as data_dir with respect to sessions
%field names must be identical to data_dir field names
must_exist_files.via11 = {'*_triggers.mat'}; %currently searches data_dir for these files
must_exist_files.via15 = {'*_triggers.mat'}; %currently searches data_dir for these files

%files to check for to determine existing subjects in BIDS directory
files_checked.via11 = {'*_eeg.bdf','*_eeg.json','*_events.tsv','*_channels.tsv'};
files_checked.via15 = {'*_eeg.bdf','*_eeg.json','*_events.tsv','*_channels.tsv'};

% parse a subject info table from database for participant information.
% info goes into participants.tsv
sub_info_table_path = '/mnt/projects/VIA11/database/VIA11_allkey_160621.csv';
id_col_name = 'famlbnr';

%only include these participant info variables
%if no variables are listed all variables are added to the participants.tsv
participant_info_include = {'MRI_age_v11', 'Sex_child_v11','HighRiskStatus_v11'};

%path to stimulation files to include in /stimuli directory in bids_dir
stim_files = {'/home/simonyj/EEG_MMN/std.wav','/home/simonyj/EEG_MMN/dev1.wav',...
            '/home/simonyj/EEG_MMN/dev2.wav','/home/simonyj/EEG_MMN/dev3.wav'};

%txt file paths to be read
event_txt_file = fullfile(data_dir.via11,'MMN_events.txt'); % txt file with information about events but not the events itself. This includes trigger values or notes about the events in general. Should have a specific format, check other events.txt
instructions_txt = fullfile(data_dir.via11,'MMN_instructions.txt'); %txt file with instructions. Should be instructions combined in one single line. 
participants_var_txt = fullfile(data_dir.via11,'participants_variables.txt'); %txt file with a description about the variables in participants.tsv. This could also include levels for categorical variables or units for variables. Has specific format.


%% Configure the setup

%read the subject table for info to go into participants.tsv 
sub_info_table = readtable(sub_info_table_path);
via_id = sub_info_table.(id_col_name); %get subject ids from the subject table. These are needed for functions to load proper subject info later.

%the path of the current script
this_file_path = mfilename('fullpath');
this_file_path = strcat(this_file_path,'.m');

%define sessions, subjects and their data_files (in this case the data_files are bdf files)
%varargin is the arguments that was parsed to this script, e.i. bids_dir and potentially single subject id and session
[sub,ses,bdf_file_names] = define_sub_ses_bdf(data_dir, data_file, via_id, varargin, nono_keywords_in_filename);

%get subjects with the additional files that was specified in the variable "must_exist_files"
if exist('must_exist_files','var')
    [subs_with_all_files,subs_with_additional_files,additional_file_names] = search_must_exist_files(data_dir,via_id,must_exist_files);
    cmp_and_print_subs_with_file(sub,subs_with_additional_files,must_exist_files,ses) % compare the subjects to be moved to the bids_dir with the subjects that has the additional files. This function also prints the comparison.
end

%prellocate memory for information about which sessions should be run
finished_ses = false(1,length(ses));
ses_run = false(1,length(ses));
ses_add = false(1,length(ses));

for s = 1:length(ses)
    %only include subjects that has the additional_files
    if exist('must_exist_files','var')
        excluded_subs = sub.(ses{s})(~ismember(sub.(ses{s}),subs_with_all_files.(ses{s}))); %subjects which does not have one of the must_exist_files

        %print warning if subjects are excluded
        if ~isempty(excluded_subs)
            fprintf('WARNING: Subject %s will not be included in the BIDS directory as they are missing a "must_exist_file" ',excluded_subs{:})
            fprintf('in session %s\n',ses{s})
            bdf_file_names.(ses{s}) = bdf_file_names.(ses{s})(~ismember(sub.(ses{s}),subs_with_all_files.(ses{s}))); %the exlusion of subjects which are already existing in the bids_dir
            sub.(ses{s}) = sub.(ses{s})(ismember(sub.(ses{s}),subs_with_all_files.(ses{s}))); %the exlusion of the subjects who does not have the must_exist_files
        end
    end
    
    %find existing subjects in the bids structure by searching for files_checked
    existing_sub = find_existing_subs(bids_dir,files_checked,ses(s));
    
    if length(varargin)==1 %if only the bids_dir is parsed to this function, e.i. running this script for multiple subjects 
        bdf_file_names.(ses{s}) = bdf_file_names.(ses{s})(~ismember(sub.(ses{s}),existing_sub.(ses{s}))); %the exlusion of subjects which are already existing in the bids_dir
        sub.(ses{s}) = sub.(ses{s})(~ismember(sub.(ses{s}),existing_sub.(ses{s}))); %the exlusion of subjects which are already existing in the bids_dir

        finished_ses(s) = isempty(sub.(ses{s})) && ~isempty(existing_sub.(ses{s})); %the sessions that are done
        ses_run(s) = ~isempty(sub.(ses{s})) && isempty(existing_sub.(ses{s})); %the sessions that should be run/started/created
        ses_add(s) = ~isempty(sub.(ses{s})) && ~isempty(existing_sub.(ses{s})); %the existing sessions with subjects to be added to
        
    elseif length(varargin)>1 %running this script for a single subject

        assert(~isempty(sub.(ses{s})),sprintf('A BIDS directory will not be made for subject %s. Check warnings above',varargin{2}))
        
        finished_ses(s) = false; %the sessions that are done
        ses_run(s) = ~isempty(sub.(ses{s})) && isempty(existing_sub.(ses{s})); %the sessions that should be run/started/created
        ses_add(s) = ~isempty(sub.(ses{s})) && ~isempty(existing_sub.(ses{s})); %the existing sessions with subjects to be added to
    end
end


%only run this script if there are unfinished sessions
assert( ~all(finished_ses), 'All relevant subject files are moved to BIDS data structure in all sessions. Add more subject files to the data_dir or run EEG2BIDS.sh for a specific subject.')

if any(ses_run)
    if length(ses{ses_run})==1
        if strcmp(ses{ses_run},'None')
            fprintf('Creating new BIDS dataset from subject files \n')
        end
    else
        fprintf('Creating new BIDS dataset session %s from subject files \n',ses{ses_run})
    end
    run_mode = 'new_BIDS';
else
    run_mode = 'exist_BIDS';
end

if any(ses_add) %sessions to add assuming that other parts of the BIDS dataset have been created successfully
    ses_to_add = ses(ses_add);
    for s = 1:length(ses_to_add)
        for ss = 1:length(sub.(ses_to_add{s}))
            fprintf('Moving subject %s files into BIDS dataset for session %s \n',sub.(ses_to_add{s}){ss},ses_to_add{s})
        end
    end
end


%% Copy the stimulation files to /stim direcotry

if exist('stim_files','var')
    
    if isstruct(stim_files)
        stim_files.
    else
        stim_files.None = stim_files;
    end
    
    bids_stim_file_path = cell(length(stim_files),1); %prellocate cell
    stim_dir = fullfile(bids_dir,'/stimuli'); %the stimuli dir in the bids_dir
    if not(isfolder(stim_dir)) %only make the stimuli dir if it does not exist
        mkdir(stim_dir)
    end

    for sf=1:length(stim_files)
        [folder,name,ext] = fileparts(stim_files{sf});
        bids_stim_file_name{sf} = strcat(name,ext); %the name of the stim files 
        bids_stim_file_path{sf} = fullfile(stim_dir,bids_stim_file_name{sf}); %the stim file paths in the bids_dir

        if strcmp(run_mode,'new_BIDS')
            copyfile( stim_files{sf}, bids_stim_file_path{sf}, 'f') %copy the stim files listed in the setup to the stim directory in the bids_dir
        end
    end
end

%% Generate BIDS structure and files

%%%%%% Use data2bids function on each subject in loop %%%%%%%%

% for more information on data2bids function see: 
% https://github.com/SimonYamazaki/fieldtrip/blob/master/data2bids.m
% which is a modified version of: https://github.com/fieldtrip/fieldtrip/blob/master/data2bids.m

if not(isfolder(bids_dir))
    mkdir(bids_dir)
end

%read instructions into cell 
if exist('instructions_txt','var')
    InstructionsC = read_txt(instructions_txt);
end


%loop over sessions and subjects to make bids_dir for

for sesindx=1:numel(ses)
    for subindx=1:numel(sub.(ses{sesindx}))
    
    % initialize config struct
    cfg = [];
    cfg.method    = 'copy'; %only copy the files
    cfg.datatype  = 'eeg'; %the type of data

    % specify the output directory (bids_dir)
    cfg.bidsroot  = bids_dir;
    
    %By default if no session is specified the cell array "ses" is named
    %'None' through functions in the EEG2BIDS_tool_dir
    if ~strcmp(ses{sesindx},'None')
        cfg.ses       = ses{sesindx};
    end
    
    % get subject ID 
    cfg.sub       = sub.(ses{sesindx}){subindx};
    sub_int       = str2num(cfg.sub);
    
    %specify that no scans.tsv file is needed for this dataset
    cfg.include_scans = false;
    
    % define data file for current subject
    if isstruct(data_dir)
        cfg.dataset   = char(fullfile(data_dir.(ses{sesindx}),bdf_file_names.(ses{sesindx}){subindx}));
    else
        cfg.dataset   = char(fullfile(data_dir,bdf_file_names.(ses{sesindx}){subindx}));
    end
    
    %general information to be put into dataset_description.json file
    if strcmp(run_mode,'new_BIDS')
        cfg.dataset_description.BIDSVersion = '1.6';
        cfg.dataset_description.Name = sprintf('%s EEG',task);
        cfg.dataset_description.DatasetType = 'raw';
        cfg.dataset_description.EthicsApprovals = {'The local Ethical Committee (Protocol number: H 16043682)','The Danish Data Protection Agency (IDnumber RHP-2017-003, I-suite no. 05333)'};
    end
    
    % specify the information for the participants.tsv file
    cfg.participants = make_participants_cfg(sub_info_table,via_id,sub_int,participant_info_include);
    
    % specify some general information that will be added to the eeg.json file
    cfg.InstitutionName             = 'Centre for Functional and Diagnostic Imagning and Research, Danish Research Center for Magnetic Resonance, Amager and Hvidovre hospital';
    cfg.InstitutionAddress          = 'Kettegard AllÃ© 30, DK-2650 Hvidovre, Denmark';
    
    % provide the mnemonic and long description of the task
    cfg.TaskName        = task;
    cfg.TaskDescription = '????';

    % EEG specific configs saved in *_eeg.json file 
    cfg.eeg.PowerLineFrequency    = 50;
    cfg.eeg.Manufacturer          = 'Biosemi';
    cfg.eeg.ManufacturersModelName = '????';
    cfg.eeg.SoftwareVersions      = '????';
    %cfg.eeg.CogPOID               = '????';
    cfg.eeg.DeviceSerialNumber    = '????';
    cfg.eeg.EEGReference          = 'Common Mode Sense (CMS) and Driven Right Leg (DRL)'; 
    
    %include the instructions if they are read
    if exist('InstructionsC','var')
        cfg.eeg.Instructions          = InstructionsC{1};
    end
    
    %software filters
    swf.filter_characteristic = '????';
    swf.filter_parameter = 10;
    swf3.filter_characteristic = '????';
    swf3.filter_parameter = 100;
    cfg.eeg.SoftwareFilters.Filter1       = swf;
    cfg.eeg.SoftwareFilters.Filter3       = swf3;
    
    %manufacturer information
    cfg.eeg.CapManufacturer = 'Biosemi';
    cfg.eeg.CapManufacturersModelName = '????';
    cfg.eeg.EEGPlacementScheme = 'radial';

    %%%%%%%  HEADER  %%%%%%%%%
    %read the header of bdf_file
    cfg.hdr = ft_read_header(cfg.dataset);
    
    %specify external channel info to the header
    %note; this does not change the header of the data file
    EXG_chan_types = cell(9,1);
    EXG_chan_types(:) = {'EMG'};
    cfg.hdr.chantype(end-8:end) = EXG_chan_types;
    EXG_chan_units = cell(9,1);
    EXG_chan_units(:) = {'uV'};
    cfg.hdr.chanunit(end-8:end) = EXG_chan_units;

    %%%%%%%%  EVENTS %%%%%%%%
    %read the events of the bdf file
    event_struct = ft_read_event(cfg.dataset);
    
    %check that the .bdf file only contains the expected amount of events
    if exist('trig_start_value','var')
        if sum([event_struct.value]==trig_start_value)~=n_trig_start
            fprintf('WARNING: Subject %s has more trigger start events than expected. Check whether the data file includes tasks other than %s.',cfg.sub,task)
        end
    end
    
    %extract the sampling frequency
    fs = cfg.hdr.Fs;  %e.g. 4096
    
    %%%%% MANUALLY DEFINE THIS SECTION FOR EVENTS TO GO INTO EVENTS.TSV %%%%%%
    delay = 37;
    load(sprintf('%s/subject_%s_MMN_triggers.mat',data_dir.(ses{sesindx}),cfg.sub));

    % estimate the start of the first sound
    bdf_event_samples = [event_struct.sample];    
    start_idx = [event_struct.value]==65281;
    empty_idx = cellfun(@isempty,{event_struct.value},'UniformOutput',1);
    timestart_idx = false(1,length(empty_idx));
    timestart_idx(not(empty_idx))=start_idx;
    
    timestart = bdf_event_samples(timestart_idx)/fs;

    %create the rest of the 1800 trials and correct for the latency between the
    %trigger and the sound
    S.trl(1,1)=timestart*fs+round((delay/1000)*fs); %-0.1*fs; %(the -0.1*fs shifts the start of the epoch to be 100ms before the sound which SPM wants)
    S.conditionlabels{1,1} = 'std';
    duration_vec(1,1) = 50/1000;
    table_sf{1,1} = bids_stim_file_name{1};
    
    trig=round(start_samples/(44100/4096));

    for i = 2:length(trig)
        S.trl(i,1)=S.trl(1,1)+trig(i);
        if mmn_codes(i)==1
            S.conditionlabels{i,:}= 'std';
            duration_vec(i,1) = 50/1000;
            table_sf{i} = bids_stim_file_name{1};
        elseif mmn_codes(i) ==2
            S.conditionlabels{i,:}= 'dev1';
            duration_vec(i,1) = 50/1000;
            table_sf{i} = bids_stim_file_name{2};
        elseif mmn_codes(i) ==3
            S.conditionlabels{i,:}='dev2';
            duration_vec(i,1) = 100/1000;
            table_sf{i} = bids_stim_file_name{3};
        elseif mmn_codes(i) ==4
            S.conditionlabels{i,:}='dev3';
            duration_vec(i,1) = 100/1000;
            table_sf{i} = bids_stim_file_name{4};
        end
    end
    
    bdf_event_table = struct2table(event_struct); 
    type = repmat({'STATUS'},length(S.conditionlabels),1) ;
    value = cell(length(S.conditionlabels),1);
    offset = cell(length(S.conditionlabels),1); %keep this variable
    duration = num2cell(duration_vec);
    sample = S.trl(:,1);
    
    generated_event_table = table(type,sample,value,offset,duration);
    event_table = [bdf_event_table;generated_event_table];

    event_table.stim_file = [cell(length(event_struct),1); table_sf'];
    event_table.delay = ones(length(event_struct)+length(S.conditionlabels),1)*delay/1000;
    event_table.conditionlabel = [cell(length(event_struct),1); S.conditionlabels(:)];
    event_table.rand_ISI = [cell(length(event_struct),1); num2cell(rand_ISI')];
    event_table.start_samples = [cell(length(event_struct),1); num2cell(start_samples')];

    cfg.events = table2struct(event_table);
    cfg.keep_events_order = true; %should the events be sorted according to sample or should it keep the order in cfg.events?

    %make bids dataset
    data2bids(cfg);
    
    end
end


%% Write events.json 

%For the current dataset all events.tsv files have identical variables,
%thus through the inheritance principle the events.json is placed in the
%bids_dir, and covers all subjects.

if strcmp(run_mode,'new_BIDS')
    %the name of the events.json 
    filename = fullfile(bids_dir, sprintf('task-%s_events.json',task));
    
    %description, units, or categorical levels of variables in events.tsv
    %this information goes into events.json
    cfg.TaskEventsDescription.onset.Description = 'Onset of stimuli. The onset of the sound being played for the subject and not the onset of epoch';
    cfg.TaskEventsDescription.onset.Units = 's';

    cfg.TaskEventsDescription.duration.Description = 'Duration of stimuli';
    cfg.TaskEventsDescription.duration.Units = 's';

    cfg.TaskEventsDescription.sample.Description = '????';
    cfg.TaskEventsDescription.sample.Units = 's';

    cfg.TaskEventsDescription.type.Description = '????';
    cfg.TaskEventsDescription.type.Levels.STATUS = 'STATUS type';
    cfg.TaskEventsDescription.type.Levels.Epoch = 'Epoch type';
    cfg.TaskEventsDescription.type.Levels.CM_in_range = 'CM_in_range type';
    
    cfg.TaskEventsDescription.delay.Description = 'Delay between the trigger and when the sound is actually played in the headphones of 37 ms';
    cfg.TaskEventsDescription.delay.Units = 's';
    
    cfg.TaskEventsDescription.conditionlabel.Description = '????';
    cfg.TaskEventsDescription.conditionlabel.Levels.Int_1 = '????';
    cfg.TaskEventsDescription.conditionlabel.Levels.Int_2 = '????';

    cfg.TaskEventsDescription.rand_ISI.Description = '????';
    cfg.TaskEventsDescription.rand_ISI.Units = '????';
    
    cfg.TaskEventsDescription.start_samples.Description = '????';
    cfg.TaskEventsDescription.start_samples.Units = '????';
    
    cfg.TaskEventsDescription.StimulusPresentation.OperatingSystem = '????';
    cfg.TaskEventsDescription.StimulusPresentation.SoftwareName = '????';
    %cfg.TaskEventsDescription.StimulusPresentation.SoftwareRRID = '????';
    cfg.TaskEventsDescription.StimulusPresentation.SoftwareVersion = '????';
    %cfg.TaskEventsDescription.StimulusPresentation.code = '????';

    if exist('event_txt_file','var')
        %read txt to a cell 
        eventsC = read_txt(event_txt_file);
        
        %write info from the event_txt_file with a specific formating and
        %extra notes to the config struct that generates events.json 
        %add value and notes to the event.json  
        extra_notes = ' The variables from subject_*SUB_ID*_MMN_triggers.mat files are added to the events.tsv files as start_sample -> start_sample, rand_ISI -> rand_ISI, mmn-codes -> conditionlabels.';
        cfg.TaskEventsDescription = read_events_txt(cfg.TaskEventsDescription,eventsC,extra_notes);
    end
    
    %check which variables in the events.tsv that are not described in the
    %config struct to generate the events.json
    non_described_vars = check_described_variables_in_tsv(bids_dir,cfg.TaskEventsDescription,sub,'events.tsv');
    
    %write the file 
    fn = fieldnames(cfg.TaskEventsDescription);
    TaskEventsDescription_settings = keepfields(cfg.TaskEventsDescription, fn);
    ft_write_json(filename, TaskEventsDescription_settings);
end




%% Write participants.json from .txt file

if strcmp(run_mode,'new_BIDS')
    
    %any additional info to include in json
    cfg.ParticipantsDescription.participant_id.Description = 'The identification number of the subject';

    %read from txt 
    participants_var = read_txt(participants_var_txt);
    
    %read the participants_var as a cell into the config struct
    cfg.ParticipantsDescription = read_participants_var_txt(cfg.ParticipantsDescription,participants_var,participant_info_include);
    
    %check which variables in the participants.tsv that are not described in the
    %config struct to generate theparticipants.json
    non_described_vars = check_described_variables_in_tsv(bids_dir,cfg.ParticipantsDescription,sub,'participants.tsv');
    
    %write the file 
    filename = fullfile(bids_dir, 'participants.json');
    fn = fieldnames(cfg.ParticipantsDescription);
    ParticipantsDescription_settings = keepfields(cfg.ParticipantsDescription, fn);
    ft_write_json(filename, ParticipantsDescription_settings);
end


%% Write channels.json file 

if strcmp(run_mode,'new_BIDS')
    filename = fullfile(cfg.bidsroot, sprintf('task-%s_channels.json',task));
    cfg.ChannelsDescription.name.Description = 'name of channel label????';
    cfg.ChannelsDescription.name.Levels.EXG1 = 'External channel 1. Mastoid left ear';
    cfg.ChannelsDescription.name.Levels.EXG2 = 'External channel 2. Mastoid right ear';
    cfg.ChannelsDescription.name.Levels.EXG3 = 'External channel 3, Left ear lobe';
    cfg.ChannelsDescription.name.Levels.EXG4 = 'External channel 4. Right ear lobe';
    cfg.ChannelsDescription.name.Levels.EXG5 = 'External channel 5. Nose';
    cfg.ChannelsDescription.name.Levels.EXG6 = 'External channel 6. Below participants right eye';
    cfg.ChannelsDescription.name.Levels.EXG7 = 'External channel 7. Above participants right eye';
    cfg.ChannelsDescription.name.Levels.EXG8 = 'External channel 8. Pulse left hand';

    fn = fieldnames(cfg.ChannelsDescription);
    ChannelsDescription_settings = keepfields(cfg.ChannelsDescription, fn);
    ft_write_json(filename, ChannelsDescription_settings);
end



%% Copy this script to the /code directory in BIDS structure 

code_dir = fullfile(bids_dir,'/code');

if not(isfolder(code_dir))
    mkdir(code_dir)
end

%copy this current script into /code in bids_dir
[folder,name,ext]=fileparts(this_file_path);
copyfile(this_file_path, fullfile(code_dir,strcat(name,ext)), 'f')

%also copy BIDS validator, json fix scripts and job scripts
if strcmp(run_mode,'new_BIDS')
    copyfile(fullfile(EEG2BIDS_tool_dir,'/change_json_int_keys.py'), fullfile(code_dir,'/change_json_int_keys.py'), 'f')
    copyfile(fullfile(EEG2BIDS_tool_dir,'/EEG2BIDS_job.sh'), fullfile(code_dir,'/EEG2BIDS_job.sh'), 'f')
    copyfile(fullfile(EEG2BIDS_tool_dir,'/EEG2BIDS.sh'), fullfile(code_dir,'/EEG2BIDS.sh'), 'f')
end


%% Write a readme and .bidsignore file 

if strcmp(run_mode,'new_BIDS')
    %write a readme about extra information
    fileID = fopen(fullfile(bids_dir,'README'),'w');
    fprintf(fileID,'Something, something');
    fclose(fileID);
    
    %write .bidsignore file for the BIDS validator
    %.bidsignore file has same syntax as .gitignore
    fileID = fopen(fullfile(bids_dir,'.bidsignore'),'w');
    fprintf(fileID,'/cluster_submissions/'); %add lines to the .bidsignore file
    fclose(fileID);
end


%% Print an ending statement

if strcmp(run_mode,'new_BIDS')
    fprintf('Created BIDS dataset in: %s\n\n',bids_dir)
else
    fprintf('Added subjects to the BIDS dataset in: %s\n\n',bids_dir)
end


end 


