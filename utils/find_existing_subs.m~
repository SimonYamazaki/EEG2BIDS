function [existing_sub] = find_existing_subs(bids_dir,files_checked,ses)
%UNTITLED5 Summary of this function goes here
%   Detailed explanation goes here

%find already existing subs by subject folders
sub_dirs = dir(sprintf('%s/sub-*',bids_dir));
file_dirs = cellstr({sub_dirs.name});
existing_sub_root = cellfun(@(x) x(end-2:end),file_dirs,'un',0);

if n
    existing_sub.(ses{s}) = existing_sub_root;
    ses = {'None'};
    existing_sub.(ses{1}) = existing_sub_root;
end

%check that the subjects with existing sub folders have the needed files 
for f = 1:length(files_checked)
    
    for s = 1:length(ses)
        if strcmp(ses{s},'None')
            sub_dirs = {dir(sprintf('%s/**/*_%s',bids_dir,files_checked{f})).name};
        else
            sub_dirs = {dir(sprintf('%s/*/ses-%s/*/*_%s',bids_dir,ses{s},files_checked{f})).name};
        end
        
        subs_with_file = cellfun(@(x) x(5:7),sub_dirs,'un',0);

        if any(~ismember(existing_sub.(ses{s}),subs_with_file))
            sub2redo = existing_sub.(ses{s}){~ismember(existing_sub.(ses{s}),subs_with_file)};
            existing_sub.(ses{s})(strcmp(existing_sub.(ses{s}),sub2redo))=[];
            
            if strcmp(ses{s},'None')
                fprintf('Subject %s is missing a %s file\n',sub2redo,files_checked{f})
            else
                fprintf('Subject %s is missing a %s file from session %s\n',sub2redo,files_checked{f},ses{s})
            end
        end
    end
end


end

